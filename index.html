<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Listening Test</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
button {
  padding: 10px 16px;
  font-size: 16px;
  margin: 5px 0;
}
.question { margin: 12px 0; }
.correct { color: green; }
.wrong { color: red; }
#timer {
  font-size: 18px;
  font-weight: bold;
  color: #d32f2f;
  margin: 10px 0;
}
#transcript {
  background: #f5f5f5;
  padding: 10px;
  margin-top: 10px;
  display: none;
}
.popup {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 12px 18px;
  border-radius: 6px;
  display: none;
}
</style>
</head>

<body>

<h2>üéß Listening Test</h2>

<label>üë§ T√™n h·ªçc sinh</label><br>
<input id="studentName"><br><br>

<label>üè´ L·ªõp</label><br>
<input id="studentClass"><br><br>

<label>üìò Ch·ªçn b√†i nghe</label><br>
<select id="lessonSelect" onchange="loadLesson()"></select><br><br>

<button id="startBtn" onclick="startExam()">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu l√†m b√†i</button>

<div id="timer">‚è± 00:00</div>

<audio id="audio" controls></audio>

<hr>

<div id="questions"></div>

<button id="submitBtn" onclick="submitExam()" disabled>üì§ N·ªôp b√†i</button>
<br><br>

<button onclick="toggleTranscript()">üìÑ Xem transcript</button>

<div id="transcript"></div>

<div id="result"></div>
<div id="popup" class="popup"></div>

<script>
/* ================== CONFIG ================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxyXC26mTJsfNS33dJuylc_F4gHaobcJt09cjXGgbS3LRQfwpkHCZgX4XnFbG9P06Gy/exec";

/* ================== LESSON DATA ================== */
const lessons = {
  lesson1: {
    name: "Lesson 1 ‚Äì Daily Routine",
    audio: "https://nicoleng274.github.io/luyen-nghe/audio/001.mp3",
    transcript: "I go to school every day. She drinks coffee in the morning.",
    questions: {
      q1: { text: "I ___ to school every day.", answer: "go", explain: "Sau I d√πng ƒë·ªông t·ª´ nguy√™n m·∫´u." },
      q2: { text: "She ___ coffee in the morning.", answer: "drinks", explain: "She l√† s·ªë √≠t ‚Üí ƒë·ªông t·ª´ th√™m -s." }
    }
  },
  lesson2: {
    name: "Lesson 2 ‚Äì Morning Habits",
    audio: "https://nicoleng274.github.io/luyen-nghe/audio/002.mp3",
    transcript: "I wake up early and eat breakfast.",
    questions: {
      q1: { text: "I ___ up early.", answer: "wake", explain: "wake up = th·ª©c d·∫≠y." },
      q2: { text: "I ___ breakfast.", answer: "eat", explain: "eat breakfast = ƒÉn s√°ng." }
    }
  }
};

let currentLesson;
let timer = null;
let time = 0;

/* ================== INIT ================== */
function init() {
  const select = document.getElementById("lessonSelect");
  for (let key in lessons) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = lessons[key].name;
    select.appendChild(opt);
  }
  loadLesson();
}
init();

/* ================== LOAD LESSON ================== */
function loadLesson() {
  const key = lessonSelect.value;
  currentLesson = lessons[key];

  audio.src = currentLesson.audio;
  audio.load();

  transcript.innerText = currentLesson.transcript;
  transcript.style.display = "none";

  questions.innerHTML = "";
  let index = 1;
  for (let q in currentLesson.questions) {
    questions.innerHTML += `
      <div class="question">
        ${index}. ${currentLesson.questions[q].text}<br>
        <input id="${q}" class="answer" disabled>
      </div>`;
    index++;
  }

  clearInterval(timer);
  time = 0;
  timerDisplay();
  startBtn.disabled = false;
  submitBtn.disabled = true;
  result.innerHTML = "";
}

/* ================== START ================== */
function startExam() {
  document.querySelectorAll(".answer").forEach(i => i.disabled = false);
  startBtn.disabled = true;
  submitBtn.disabled = false;

  timer = setInterval(() => {
    time++;
    timerDisplay();
  }, 1000);
}

function timerDisplay() {
  const m = String(Math.floor(time / 60)).padStart(2, "0");
  const s = String(time % 60).padStart(2, "0");
  timer.innerText = `‚è± ${m}:${s}`;
}

/* ================== SUBMIT ================== */
async function submitExam() {
  clearInterval(timer);

  let score = 0;
  let total = Object.keys(currentLesson.questions).length;
  let html = `<h3>K·∫øt qu·∫£ (${score}/${total})</h3>`;

  for (let q in currentLesson.questions) {
    const user = document.getElementById(q).value.trim().toLowerCase();
    const { answer, explain } = currentLesson.questions[q];

    if (user === answer) {
      score++;
      html += `<p class="correct">‚úî ${q} ƒë√∫ng</p>`;
    } else {
      html += `<p class="wrong">‚ùå ${q} sai<br>
        ƒê√°p √°n: <b>${answer}</b><br>
        ${explain}</p>`;
    }
  }

  result.innerHTML = `<h3>K·∫øt qu·∫£: ${score}/${total}</h3>` + html;

  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        lesson: lessonSelect.value,                 // t√™n sheet: lesson1, lesson2
        class: studentClass.value || "",            // üî¥ L·∫§Y T·ª™ INPUT L·ªöP
        student: studentName.value || "Unknown",
        score: score,
        total: total,
        date: new Date().toLocaleDateString("vi-VN"),
        time: `${Math.floor(time / 60)}:${String(time % 60).padStart(2, "0")}`
      })
    });
    showPopup("‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm");
  } catch {
    showPopup("‚ùå L·ªói l∆∞u ƒëi·ªÉm");
  }
}

/* ================== UI ================== */
function toggleTranscript() {
  transcript.style.display =
    transcript.style.display === "none" ? "block" : "none";
}

function showPopup(text) {
  popup.innerText = text;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}
</script>

</body>
</html>
