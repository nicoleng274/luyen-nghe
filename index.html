<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Listening Test</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}

button {
  padding: 10px 16px;
  font-size: 16px;
  margin: 5px 0;
}

.question { margin: 14px 0; }

input.answer {
  padding: 6px;
  font-size: 15px;
  width: 160px;
}

.correct {
  border: 2px solid #4caf50;
}

.wrong {
  border: 2px solid #f44336;
}

.explain {
  display: none;
  background: #f5f5f5;
  padding: 8px;
  margin-top: 6px;
  border-left: 4px solid #2196f3;
}

#examArea {
  display: none;
}

#transcript {
  display: none;
  background: #eee;
  padding: 10px;
  margin-top: 10px;
}

.popup {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 12px 18px;
  border-radius: 6px;
  display: none;
}
</style>
</head>

<body>

<h2>ğŸ§ Listening Test</h2>

<label>ğŸ‘¤ TÃªn há»c sinh</label><br>
<input id="studentName"><br><br>

<label>ğŸ« Lá»›p</label><br>
<input id="studentClass"><br><br>

<label>ğŸ“˜ Chá»n bÃ i nghe</label><br>
<select id="lessonSelect"></select><br><br>

<button id="startBtn" onclick="startExam()">â–¶ï¸ Báº¯t Ä‘áº§u lÃ m bÃ i</button>

<div id="examArea">
  <audio id="audio" controls></audio>
  <hr>
  <div id="questions"></div>

  <button id="submitBtn" onclick="submitExam()">ğŸ“¤ Ná»™p bÃ i</button>
</div>

<button onclick="toggleTranscript()">ğŸ“„ Xem transcript</button>

<div id="transcript"></div>

<div id="popup" class="popup"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyAlISLVOd5uo8RWDuHqlvPrRgLf0JvcdE0lDXqI9TsxLeothwTKjq2mBKhdrQUIxdx/exec";

const lessons = {
  lesson1: {
    name: "Lesson 1 â€“ Daily Routine",
    audio: "https://nicoleng274.github.io/luyen-nghe/audio/001.mp3",
    transcript: "I go to school every day. She drinks coffee in the morning.",
    questions: {
      q1: { text: "I ___ to school every day.", answer: "go", explain: "Sau I dÃ¹ng Ä‘á»™ng tá»« nguyÃªn máº«u." },
      q2: { text: "She ___ coffee in the morning.", answer: "drinks", explain: "She lÃ  sá»‘ Ã­t â†’ Ä‘á»™ng tá»« thÃªm -s." }
    }
  }
};

let currentLesson;
let submitted = false;

function init() {
  const select = lessonSelect;
  for (let key in lessons) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = lessons[key].name;
    select.appendChild(opt);
  }
}
init();

function startExam() {
  submitted = false;
  examArea.style.display = "block";
  startBtn.disabled = true;

  currentLesson = lessons[lessonSelect.value];
  audio.src = currentLesson.audio;

  transcript.innerText = currentLesson.transcript;
  transcript.style.display = "none";

  questions.innerHTML = "";
  let i = 1;
  for (let q in currentLesson.questions) {
    questions.innerHTML += `
      <div class="question">
        ${i}. ${currentLesson.questions[q].text}<br>
        <input id="${q}" class="answer">
        <span id="${q}-icon"></span>
        <div>
          <button onclick="toggleExplain('${q}')">Xem giáº£i thÃ­ch</button>
          <div id="${q}-explain" class="explain">
            ${currentLesson.questions[q].explain}
          </div>
        </div>
      </div>`;
    i++;
  }
}

async function submitExam() {
  submitted = true;

  let score = 0;
  let total = Object.keys(currentLesson.questions).length;

  for (let q in currentLesson.questions) {
    const input = document.getElementById(q);
    const icon = document.getElementById(q + "-icon");
    const user = input.value.trim().toLowerCase();
    const ans = currentLesson.questions[q].answer;

    if (user === ans) {
      score++;
      input.classList.add("correct");
      icon.innerHTML = " âœ”";
    } else {
      input.classList.add("wrong");
      icon.innerHTML = " âœ– (ÄÃºng: " + ans + ")";
    }
    input.disabled = true;
  }

  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      lesson: lessonSelect.value,
      class: studentClass.value,
      student: studentName.value,
      score,
      total,
      date: new Date().toLocaleDateString("vi-VN"),
      time: new Date().toLocaleTimeString("vi-VN")
    })
  });

  showPopup("âœ… ÄÃ£ ná»™p & lÆ°u Ä‘iá»ƒm");
}

function toggleExplain(q) {
  if (!submitted) return;
  const div = document.getElementById(q + "-explain");
  div.style.display = div.style.display === "none" ? "block" : "none";
}

function toggleTranscript() {
  if (!submitted) return;
  transcript.style.display =
    transcript.style.display === "none" ? "block" : "none";
}

function showPopup(text) {
  popup.innerText = text;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}
</script>

</body>
</html>
