<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Listening Test</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
button {
  padding: 10px 16px;
  font-size: 16px;
  margin: 5px 0;
}
.question { margin: 12px 0; }
.correct { color: green; }
.wrong { color: red; }
#transcript {
  background: #f5f5f5;
  padding: 10px;
  margin-top: 10px;
  display: none;
}
.popup {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 12px 18px;
  border-radius: 6px;
  display: none;
}
</style>
</head>

<body>

<h2>ğŸ§ Listening Test</h2>

<label>ğŸ‘¤ TÃªn há»c sinh</label><br>
<input id="studentName"><br><br>

<label>ğŸ« Lá»›p</label><br>
<input id="studentClass"><br><br>

<label>ğŸ“˜ Chá»n bÃ i nghe</label><br>
<select id="lessonSelect" onchange="loadLesson()"></select><br><br>

<button id="startBtn" onclick="startExam()">â–¶ï¸ Báº¯t Ä‘áº§u lÃ m bÃ i</button>

<audio id="audio" controls></audio>

<hr>

<div id="questions"></div>

<button id="submitBtn" onclick="submitExam()" disabled>ğŸ“¤ Ná»™p bÃ i</button>
<br><br>

<button onclick="toggleTranscript()">ğŸ“„ Xem transcript</button>

<div id="transcript"></div>

<div id="result"></div>
<div id="popup" class="popup"></div>

<script>
/* ================== CONFIG ================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyT4bpz5jaQpHmEqHWNgjSdnFh872DMWNSB0BERxwKtaj0j-os2sAKE7h0dxrrr5gs2/exec";

/* ================== LESSON DATA ================== */
const lessons = {
  lesson1: {
    name: "Lesson 1 â€“ Daily Routine",
    audio: "https://nicoleng274.github.io/luyen-nghe/audio/001.mp3",
    transcript: "I go to school every day. She drinks coffee in the morning.",
    questions: {
      q1: { text: "I ___ to school every day.", answer: "go", explain: "Sau I dÃ¹ng Ä‘á»™ng tá»« nguyÃªn máº«u." },
      q2: { text: "She ___ coffee in the morning.", answer: "drinks", explain: "She lÃ  sá»‘ Ã­t â†’ Ä‘á»™ng tá»« thÃªm -s." }
    }
  },
  lesson2: {
    name: "Lesson 2 â€“ Morning Habits",
    audio: "https://nicoleng274.github.io/luyen-nghe/audio/002.mp3",
    transcript: "I wake up early and eat breakfast.",
    questions: {
      q1: { text: "I ___ up early.", answer: "wake", explain: "wake up = thá»©c dáº­y." },
      q2: { text: "I ___ breakfast.", answer: "eat", explain: "eat breakfast = Äƒn sÃ¡ng." }
    }
  }
};

let currentLesson;

/* ================== INIT ================== */
function init() {
  const select = document.getElementById("lessonSelect");
  for (let key in lessons) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = lessons[key].name;
    select.appendChild(opt);
  }
  loadLesson();
}
init();

/* ================== LOAD LESSON ================== */
function loadLesson() {
  currentLesson = lessons[lessonSelect.value];

  audio.src = currentLesson.audio;
  audio.load();

  transcript.innerText = currentLesson.transcript;
  transcript.style.display = "none";

  questions.innerHTML = "";
  let index = 1;
  for (let q in currentLesson.questions) {
    questions.innerHTML += `
      <div class="question">
        ${index}. ${currentLesson.questions[q].text}<br>
        <input id="${q}" class="answer" disabled>
      </div>`;
    index++;
  }

  startBtn.disabled = false;
  submitBtn.disabled = true;
  result.innerHTML = "";
}

/* ================== START ================== */
function startExam() {
  document.querySelectorAll(".answer").forEach(i => i.disabled = false);
  startBtn.disabled = true;
  submitBtn.disabled = false;
}

/* ================== SUBMIT ================== */
async function submitExam() {
  let score = 0;
  let total = Object.keys(currentLesson.questions).length;
  let html = "";

  for (let q in currentLesson.questions) {
    const user = document.getElementById(q).value.trim().toLowerCase();
    const { answer, explain } = currentLesson.questions[q];

    if (user === answer) {
      score++;
      html += `<p class="correct">âœ” ${q} Ä‘Ãºng</p>`;
    } else {
      html += `<p class="wrong">âŒ ${q} sai<br>
        ÄÃ¡p Ã¡n: <b>${answer}</b><br>${explain}</p>`;
    }
  }

  result.innerHTML = `<h3>Káº¿t quáº£: ${score}/${total}</h3>` + html;

  /* ====== SEND TO GOOGLE SHEET (FIXED) ====== */
  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      lesson: lessonSelect.value,
      class: studentClass.value || "",
      student: studentName.value || "Unknown",
      score: score,
      total: total,
      date: new Date().toLocaleDateString("vi-VN")
    })
  });

  showPopup("âœ… ÄÃ£ lÆ°u Ä‘iá»ƒm");
}

/* ================== UI ================== */
function toggleTranscript() {
  transcript.style.display =
    transcript.style.display === "none" ? "block" : "none";
}

function showPopup(text) {
  popup.innerText = text;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}
</script>

</body>
</html>
